---
mode: 'agent'
tools: ['codebase']
description: 'あらゆる言語やフレームワークに対して最適化されたマルチステージDockerfileを作成します'
---

あなたの目標は、より小さく、より安全なコンテナイメージを作成するベストプラクティスに従った効率的なマルチステージDockerfileの作成をお手伝いすることです。

## マルチステージ構造

- コンパイル、依存関係のインストール、その他のビルド時操作にビルダーステージを使用する
- アプリケーションの実行に必要なもののみを含む個別のランタイムステージを使用する
- ビルダーステージからランタイムステージに必要なアーティファクトのみをコピーする
- `AS`キーワードで意味のあるステージ名を使用する（例：`FROM node:18 AS builder`）
- 論理的な順序でステージを配置：依存関係 → ビルド → テスト → ランタイム

## ベースイメージ

- 可能な場合は公式の最小限のベースイメージから開始する
- 再現可能なビルドを保証するため正確なバージョンタグを指定する（例：単に`python`ではなく`python:3.11-slim`）
- 適切な場合はランタイムステージにdistrolessイメージを検討する
- アプリケーションと互換性がある場合は、より小さなフットプリントのためにAlpineベースのイメージを使用する
- ランタイムイメージが最小限の必要な依存関係を持つことを確認する

## レイヤー最適化

- レイヤーキャッシュを最大化するようにコマンドを整理する
- 頻繁に変更されるコマンド（コード変更など）を、変更頻度の低いコマンド（依存関係のインストールなど）の後に配置する
- 不要なファイルがビルドコンテキストに含まれることを防ぐために`.dockerignore`を使用する
- レイヤー数を減らすために関連するRUNコマンドを`&&`で結合する
- 権限を一度に設定するために`COPY --chown`の使用を検討する

## セキュリティプラクティス

- コンテナをrootとして実行することを避ける - 非rootユーザーを指定するために`USER`命令を使用する
- 最終イメージからビルドツールと不要なパッケージを削除する
- 脆弱性について最終イメージをスキャンする
- 制限的なファイル権限を設定する
- 最終イメージにビルドシークレットが含まれることを避けるためにマルチステージビルドを使用する

## パフォーマンス考慮事項

- 環境間で変更される可能性のある設定にはビルド引数を使用する
- 変更頻度の低いものから高いものへレイヤーを順序付けすることでビルドキャッシュを効率的に活用する
- 可能な場合はビルドステップでの並列化を検討する
- ランタイムの動作を最適化するためにNODE_ENV=productionなどの適切な環境変数を設定する
- HEALTHCHECK命令でアプリケーションタイプに適したヘルスチェックを使用する