---
mode: 'agent'
description: 'アプリで使用されるAzureリソース（IaCファイルおよび/またはターゲットRG内のリソース）を分析し、コストを最適化 - 特定された最適化のためのGitHubイシューを作成します。'
---

# Azure コスト最適化

このワークフローは、Infrastructure-as-Code（IaC）ファイルとAzureリソースを分析して、コスト最適化の推奨事項を生成します。各最適化機会に対して個別のGitHubイシューを作成し、さらに実装を調整するための1つのEPICイシューを作成することで、コスト削減イニシアチブの効率的な追跡と実行を可能にします。

## 前提条件
- Azure MCPサーバーが設定・認証されていること
- GitHub MCPサーバーが設定・認証されていること  
- ターゲットGitHubリポジトリが特定されていること
- Azureリソースがデプロイされていること（IaCファイルはオプションですが有用）
- 利用可能な場合はAzure CLIよりもAzure MCPツール（`azmcp-*`）を優先する

## ワークフロー手順

### ステップ1: Azureベストプラクティスの取得
**アクション**: 分析前にコスト最適化のベストプラクティスを取得
**ツール**: Azure MCPベストプラクティスツール
**プロセス**:
1. **ベストプラクティスの読み込み**:
   - `azmcp-bestpractices-get`を実行して最新のAzure最適化ガイドラインの一部を取得。これはすべてのシナリオをカバーしていない可能性がありますが、基盤を提供します。
   - これらの実践を使用して、後続の分析と推奨事項を可能な限り情報に基づいて行います
   - MCPツールの出力または一般的なAzureドキュメントから、最適化推奨事項でベストプラクティスを参照します

### ステップ2: Azureインフラストラクチャの発見
**アクション**: Azureリソースと設定を動的に発見・分析
**ツール**: Azure MCPツール + Azure CLIフォールバック + ローカルファイルシステムアクセス
**プロセス**:
1. **リソース発見**:
   - `azmcp-subscription-list`を実行して利用可能なサブスクリプションを見つける
   - `azmcp-group-list --subscription <subscription-id>`を実行してリソースグループを見つける
   - 関連するグループのすべてのリソースのリストを取得:
     - `az resource list --subscription <id> --resource-group <name>`を使用
   - 各リソースタイプについて、可能であればまずMCPツール、次にCLIフォールバックを使用:
     - `azmcp-cosmos-account-list --subscription <id>` - Cosmos DBアカウント
     - `azmcp-storage-account-list --subscription <id>` - ストレージアカウント  
     - `azmcp-monitor-workspace-list --subscription <id>` - Log Analyticsワークスペース
     - `azmcp-keyvault-key-list` - Key Vault
     - `az webapp list` - Web Apps（フォールバック - MCPツールなし）
     - `az appservice plan list` - App Service Plans（フォールバック）
     - `az functionapp list` - Function Apps（フォールバック）
     - `az sql server list` - SQL Servers（フォールバック）
     - `az redis list` - Redis Cache（フォールバック）
     - その他のリソースタイプも同様

2. **IaC検出**:
   - `file_search`を使用してIaCファイルをスキャン: "**/*.bicep", "**/*.tf", "**/main.json", "**/*template*.json"
   - リソース定義を解析して意図された設定を理解
   - 発見されたリソースと比較して不一致を特定
   - 後で実装推奨事項のためにIaCファイルの存在を記録
   - リポジトリから他のファイルは使用しない、IaCファイルのみ使用すること。他のファイルの使用は真実の情報源ではないため禁止されています。
   - IaCファイルが見つからない場合は、停止してIaCファイルが見つからないことをユーザーに報告してください。

3. **設定分析**:
   - 各リソースの現在のSKU、ティア、設定を抽出
   - リソースの関係と依存関係を特定
   - 利用可能な場合はリソース使用パターンをマッピング

### ステップ3: 使用メトリクスの収集・現在のコストの検証
**アクション**: 使用率データを収集し、実際のリソースコストを検証
**ツール**: Azure MCP監視ツール + Azure CLI
**プロセス**:
1. **監視ソースの検索**:
   - `azmcp-monitor-workspace-list --subscription <id>`を使用してLog Analyticsワークスペースを見つける
   - `azmcp-monitor-table-list --subscription <id> --workspace <name> --table-type "CustomLog"`を使用して利用可能なデータを発見

2. **使用クエリの実行**:
   - 以下の事前定義されたクエリで`azmcp-monitor-log-query`を使用:
     - クエリ: "recent"で最近のアクティビティパターン
     - クエリ: "errors"で問題を示すエラーレベルログ
   - カスタム分析にはKQLクエリを使用:
   ```kql
   // App ServicesのCPU使用率
   AppServiceAppLogs
   | where TimeGenerated > ago(7d)
   | summarize avg(CpuTime) by Resource, bin(TimeGenerated, 1h)
   
   // Cosmos DB RU消費量  
   AzureDiagnostics
   | where ResourceProvider == "MICROSOFT.DOCUMENTDB"
   | where TimeGenerated > ago(7d)
   | summarize avg(RequestCharge) by Resource
   
   // ストレージアカウントアクセスパターン
   StorageBlobLogs
   | where TimeGenerated > ago(7d)
   | summarize RequestCount=count() by AccountName, bin(TimeGenerated, 1d)
   ```

3. **ベースラインメトリクスの計算**:
   - CPU/メモリ使用率平均
   - データベーススループットパターン
   - ストレージアクセス頻度
   - 関数実行率

4. **現在のコストの検証**: 
   - ステップ2で発見されたSKU/ティア設定を使用
   - https://azure.microsoft.com/pricing/で現在のAzure価格を調べるか`az billing`コマンドを使用
   - 文書化: リソース → 現在のSKU → 推定月額コスト
   - 推奨事項に進む前に現実的な現在の月額合計を計算

### ステップ4: コスト最適化推奨事項の生成
**アクション**: リソースを分析して最適化機会を特定
**ツール**: 収集されたデータを使用したローカル分析
**プロセス**:
1. **見つかったリソースタイプに基づく最適化パターンの適用**:
   
   **コンピュート最適化**:
   - App Service Plans: CPU/メモリ使用量に基づいて適切にサイジング
   - Function Apps: 低使用量の場合Premium → 従量課金プランへ
   - 仮想マシン: 過大なインスタンスをスケールダウン
   
   **データベース最適化**:
   - Cosmos DB: 
     - 可変ワークロードに対してプロビジョン済み → サーバーレス
     - 実際の使用量に基づいてRU/sを適切にサイジング
   - SQL Database: DTU使用量に基づいてサービスティアを適切にサイジング
   
   **ストレージ最適化**:
   - ライフサイクルポリシーの実装（ホット → クール → アーカイブ）
   - 冗長なストレージアカウントの統合
   - アクセスパターンに基づくストレージティアの適切なサイジング
   
   **インフラストラクチャ最適化**:
   - 未使用/冗長リソースの削除
   - 有益な場合の自動スケーリング実装
   - 非本番環境のスケジューリング

2. **エビデンスベースの節約の計算**: 
   - 現在の検証済みコスト → ターゲットコスト = 節約額
   - 現在とターゲットの両方の設定の価格ソースを文書化

3. **各推奨事項の優先度スコアを計算**:
   ```
   優先度スコア = (価値スコア × 月額節約額) / (リスクスコア × 実装日数)
   
   高優先度: スコア > 20
   中優先度: スコア 5-20
   低優先度: スコア < 5
   ```

4. **推奨事項の検証**:
   - Azure CLIコマンドが正確であることを確認
   - 推定節約額の計算を検証
   - 実装リスクと前提条件を評価
   - すべての節約額の計算が裏付けとなるエビデンスを持つことを確認

### ステップ5: ユーザー確認
**アクション**: サマリーを提示してGitHubイシューを作成する前に承認を得る
**プロセス**:
1. **最適化サマリーの表示**:
   ```
   🎯 Azure コスト最適化サマリー
   
   📊 分析結果:
   • 分析されたリソース総数: X
   • 現在の月額コスト: $X 
   • 潜在的月額節約額: $Y 
   • 最適化機会: Z
   • 高優先度アイテム: N
   
   🏆 推奨事項:
   1. [リソース]: [現在のSKU] → [ターゲットSKU] = $X/月節約 - [リスクレベル] | [実装工数]
   2. [リソース]: [現在の設定] → [ターゲット設定] = $Y/月節約 - [リスクレベル] | [実装工数]
   3. [リソース]: [現在の設定] → [ターゲット設定] = $Z/月節約 - [リスクレベル] | [実装工数]
   ... など
   
   💡 これにより作成されます:
   • Y個の個別GitHubイシュー（最適化毎に1つ）
   • 1個のEPICイシューで実装を調整
   
   ❓ GitHubイシューの作成を続行しますか？ (y/n)
   ```

2. **ユーザー確認の待機**: ユーザーが確認した場合のみ続行

### ステップ6: 個別最適化イシューの作成
**アクション**: 各最適化機会に対して別々のGitHubイシューを作成。"cost-optimization"（緑色）、"azure"（青色）のラベルを付ける。
**必要なMCPツール**: 各推奨事項に対する`create_issue`
**プロセス**:
1. **このテンプレートを使用して個別イシューを作成**:

   **タイトル形式**: `[COST-OPT] [リソースタイプ] - [簡潔な説明] - $X/月節約`
   
   **本文テンプレート**:
   ```markdown
   ## 💰 コスト最適化: [簡潔なタイトル]
   
   **月額節約額**: $X | **リスクレベル**: [低/中/高] | **実装工数**: X日
   
   ### 📋 説明
   [最適化とそれが必要な理由の明確な説明]
   
   ### 🔧 実装
   
   **IaCファイル検出**: [はい/いいえ - file_search結果に基づく]
   
   ```bash
   # IaCファイルが見つかった場合: IaC変更 + デプロイを表示
   # ファイル: infrastructure/bicep/modules/app-service.bicep
   # 変更: sku.name: 'S3' → 'B2'
   az deployment group create --resource-group [rg] --template-file infrastructure/bicep/main.bicep
   
   # IaCファイルなしの場合: 直接Azure CLIコマンド + 警告
   # ⚠️ IaCファイルが見つかりません。他の場所に存在する場合は、代わりにそれらを変更してください。
   az appservice plan update --name [plan] --sku B2
   ```
   
   ### 📊 エビデンス
   - 現在の設定: [詳細]
   - 使用パターン: [監視データからのエビデンス]
   - コスト影響: $X/月 → $Y/月
   - ベストプラクティス整合性: [該当する場合はAzureベストプラクティスへの参照]
   
   ### ✅ 検証ステップ
   - [ ] 非本番環境でテスト
   - [ ] パフォーマンス劣化がないことを確認
   - [ ] Azure Cost Managementでコスト削減を確認
   - [ ] 必要に応じて監視とアラートを更新
   
   ### ⚠️ リスクと考慮事項
   - [リスク1と軽減策]
   - [リスク2と軽減策]
   
   **優先度スコア**: X | **価値**: X/10 | **リスク**: X/10
   ```

### ステップ7: EPIC調整イシューの作成
**アクション**: すべての最適化作業を追跡するマスターイシューを作成。"cost-optimization"（緑色）、"azure"（青色）、"epic"（紫色）のラベルを付ける。
**必要なMCPツール**: EPICの`create_issue`
**mermaid図について注記**: mermaid構文が正しいことを確認し、アクセシビリティガイドライン（スタイリング、色など）を考慮して図を作成してください。
**プロセス**:
1. **EPICイシューの作成**:

   **タイトル**: `[EPIC] Azure コスト最適化イニシアチブ - $X/月の潜在的節約`
   
   **本文テンプレート**:
   ```markdown
   # 🎯 Azure コスト最適化EPIC
   
   **潜在的総節約額**: $X/月 | **実装タイムライン**: X週間
   
   ## 📊 エグゼクティブサマリー
   - **分析されたリソース**: X
   - **最適化機会**: Y  
   - **総月額節約ポテンシャル**: $X
   - **高優先度アイテム**: N
   
   ## 🏗️ 現在のアーキテクチャ概要
   
   ```mermaid
   graph TB
       subgraph "リソースグループ: [名前]"
           [現在のリソースとコストを示す生成されたアーキテクチャ図]
       end
   ```
   
   ## 📋 実装追跡
   
   ### 🚀 高優先度（最初に実装）
   - [ ] #[イシュー番号]: [タイトル] - $X/月節約
   - [ ] #[イシュー番号]: [タイトル] - $X/月節約
   
   ### ⚡ 中優先度 
   - [ ] #[イシュー番号]: [タイトル] - $X/月節約
   - [ ] #[イシュー番号]: [タイトル] - $X/月節約
   
   ### 🔄 低優先度（あると良い）
   - [ ] #[イシュー番号]: [タイトル] - $X/月節約
   
   ## 📈 進捗追跡
   - **完了**: Y個の最適化のうち0個
   - **実現された節約額**: $X/月のうち$0
   - **実装ステータス**: 未開始
   
   ## 🎯 成功基準
   - [ ] すべての高優先度最適化が実装された
   - [ ] 推定節約額の80%以上が実現された
   - [ ] パフォーマンス劣化が観察されない
   - [ ] コスト監視ダッシュボードが更新された
   
   ## 📝 注記
   - イシューが完了したらこのEPICをレビュー・更新する
   - 実際の節約額と推定節約額を監視する
   - 定期的なコスト最適化レビューのスケジューリングを検討する
   ```

## エラー処理
- **コスト検証**: 節約額推定に裏付けエビデンスがない、またはAzure価格と一致しないように見える場合、続行前に設定と価格ソースを再検証
- **Azure認証失敗**: 手動Azure CLI設定手順を提供
- **リソースが見つからない**: Azureリソースデプロイに関する情報イシューを作成
- **GitHub作成失敗**: フォーマット済み推奨事項をコンソールに出力
- **不十分な使用データ**: 制限を記録し、設定ベースの推奨事項のみを提供

## 成功基準
- ✅ すべてのコスト推定が実際のリソース設定とAzure価格に対して検証済み
- ✅ 各最適化に対して個別イシューを作成（追跡可能・割り当て可能）
- ✅ EPICイシューが包括的な調整と追跡を提供
- ✅ すべての推奨事項に具体的で実行可能なAzure CLIコマンドを含む
- ✅ 優先度スコアリングでROI重視の実装を可能にする
- ✅ アーキテクチャ図が現在の状態を正確に表現
- ✅ ユーザー確認で不要なイシュー作成を防止