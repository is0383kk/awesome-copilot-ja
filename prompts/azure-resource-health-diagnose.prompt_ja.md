---
mode: 'agent'
description: 'Azureリソースヘルスを分析し、ログとテレメトリから問題を診断し、特定された問題の修復計画を作成します。'
---

# Azureリソースヘルス・問題診断

このワークフローは、特定のAzureリソースを分析してヘルス状態を評価し、ログとテレメトリデータを使用して潜在的な問題を診断し、発見された問題の包括的な修復計画を開発します。

## 前提条件
- Azure MCPサーバーが設定・認証されていること
- ターゲットAzureリソースが特定されていること（名前と任意でリソースグループ/サブスクリプション）
- ログ/テレメトリを生成するためにリソースがデプロイされ実行されている必要があります
- 利用可能な場合はAzure CLIよりもAzure MCPツール（`azmcp-*`）を優先する

## ワークフロー手順

### ステップ1: Azureベストプラクティスの取得
**アクション**: 診断とトラブルシューティングのベストプラクティスを取得
**ツール**: Azure MCPベストプラクティスツール
**プロセス**:
1. **ベストプラクティスの読み込み**:
   - Azure ベストプラクティスツールを実行して診断ガイドラインを取得
   - ヘルス監視、ログ分析、問題解決パターンに焦点を当てる
   - これらの実践を使用して診断アプローチと修復推奨事項を情報に基づいて行う

### ステップ2: リソース発見・特定
**アクション**: ターゲットAzureリソースを見つけて特定
**ツール**: Azure MCPツール + Azure CLIフォールバック
**プロセス**:
1. **リソース検索**:
   - リソース名のみが提供された場合: `azmcp-subscription-list`を使用してサブスクリプション全体を検索
   - `az resource list --name <リソース名>`を使用して一致するリソースを見つける
   - 複数の一致が見つかった場合、ユーザーにサブスクリプション/リソースグループを指定するよう促す
   - 詳細なリソース情報を収集:
     - リソースタイプと現在のステータス
     - 場所、タグ、設定
     - 関連サービスと依存関係

2. **リソースタイプ検出**:
   - 適切な診断アプローチを決定するためにリソースタイプを特定:
     - **Web Apps/Function Apps**: アプリケーションログ、パフォーマンスメトリクス、依存関係追跡
     - **Virtual Machines**: システムログ、パフォーマンスカウンター、ブート診断
     - **Cosmos DB**: リクエストメトリクス、スロットリング、パーティション統計
     - **Storage Accounts**: アクセスログ、パフォーマンスメトリクス、可用性
     - **SQL Database**: クエリパフォーマンス、接続ログ、リソース使用率
     - **Application Insights**: アプリケーションテレメトリ、例外、依存関係
     - **Key Vault**: アクセスログ、証明書ステータス、シークレット使用
     - **Service Bus**: メッセージメトリクス、デッドレターキュー、スループット

### ステップ3: ヘルス状態評価
**アクション**: 現在のリソースヘルスと可用性を評価
**ツール**: Azure MCP監視ツール + Azure CLI
**プロセス**:
1. **基本ヘルスチェック**:
   - リソースプロビジョニング状態と操作ステータスを確認
   - サービス可用性と応答性を検証
   - 最近のデプロイや設定変更をレビュー
   - 現在のリソース使用率（CPU、メモリ、ストレージなど）を評価

2. **サービス固有のヘルス指標**:
   - **Web Apps**: HTTP応答コード、応答時間、稼働時間
   - **データベース**: 接続成功率、クエリパフォーマンス、デッドロック
   - **ストレージ**: 可用性パーセンテージ、リクエスト成功率、レイテンシ
   - **VM**: ブート診断、ゲストOSメトリクス、ネットワーク接続
   - **Functions**: 実行成功率、実行時間、エラー頻度

### ステップ4: ログ・テレメトリ分析
**アクション**: 問題とパターンを特定するためにログとテレメトリを分析
**ツール**: Log AnalyticsクエリのためのAzure MCP監視ツール
**プロセス**:
1. **監視ソースの発見**:
   - `azmcp-monitor-workspace-list`を使用してLog Analyticsワークスペースを特定
   - リソースに関連するApplication Insightsインスタンスを見つける
   - `azmcp-monitor-table-list`を使用して関連するログテーブルを特定

2. **診断クエリの実行**:
   リソースタイプに基づいてターゲット化されたKQLクエリで`azmcp-monitor-log-query`を使用:

   **一般エラー分析**:
   ```kql
   // 最近のエラーと例外
   union isfuzzy=true 
       AzureDiagnostics,
       AppServiceHTTPLogs,
       AppServiceAppLogs,
       AzureActivity
   | where TimeGenerated > ago(24h)
   | where Level == "Error" or ResultType != "Success"
   | summarize ErrorCount=count() by Resource, ResultType, bin(TimeGenerated, 1h)
   | order by TimeGenerated desc
   ```

   **パフォーマンス分析**:
   ```kql
   // パフォーマンス劣化パターン
   Perf
   | where TimeGenerated > ago(7d)
   | where ObjectName == "Processor" and CounterName == "% Processor Time"
   | summarize avg(CounterValue) by Computer, bin(TimeGenerated, 1h)
   | where avg_CounterValue > 80
   ```

   **アプリケーション固有のクエリ**:
   ```kql
   // Application Insights - 失敗したリクエスト
   requests
   | where timestamp > ago(24h)
   | where success == false
   | summarize FailureCount=count() by resultCode, bin(timestamp, 1h)
   | order by timestamp desc
   
   // データベース - 接続失敗
   AzureDiagnostics
   | where ResourceProvider == "MICROSOFT.SQL"
   | where Category == "SQLSecurityAuditEvents"
   | where action_name_s == "CONNECTION_FAILED"
   | summarize ConnectionFailures=count() by bin(TimeGenerated, 1h)
   ```

3. **パターン認識**:
   - 繰り返しエラーパターンや異常を特定
   - エラーをデプロイ時間や設定変更と相関付ける
   - パフォーマンストレンドと劣化パターンを分析
   - 依存関係の失敗や外部サービスの問題を探す

### ステップ5: 問題分類・根本原因分析
**アクション**: 特定された問題を分類し根本原因を決定
**プロセス**:
1. **問題分類**:
   - **クリティカル**: サービス利用不可、データ損失、セキュリティ侵害
   - **高**: パフォーマンス劣化、間欠的障害、高エラー率
   - **中**: 警告、準最適設定、軽微なパフォーマンス問題
   - **低**: 情報アラート、最適化機会

2. **根本原因分析**:
   - **設定問題**: 不正な設定、依存関係の欠如
   - **リソース制約**: CPU/メモリ/ディスク制限、スロットリング
   - **ネットワーク問題**: 接続問題、DNS解決、ファイアウォールルール
   - **アプリケーション問題**: コードバグ、メモリリーク、非効率なクエリ
   - **外部依存関係**: サードパーティサービス障害、API制限
   - **セキュリティ問題**: 認証失敗、証明書期限切れ

3. **影響評価**:
   - ビジネス影響と影響を受けるユーザー/システムを決定
   - データ整合性とセキュリティの影響を評価
   - 復旧時間目標と優先度を評価

### ステップ6: 修復計画の生成
**アクション**: 特定された問題に対処する包括的な計画を作成
**プロセス**:
1. **即座のアクション**（クリティカル問題）:
   - サービス可用性を復旧する緊急修正
   - 影響を軽減する一時的な回避策
   - 複雑な問題のエスカレーション手順

2. **短期修正**（高/中問題）:
   - 設定調整とリソーススケーリング
   - アプリケーション更新とパッチ
   - 監視とアラート改善

3. **長期改善**（全問題）:
   - より良い回復力のためのアーキテクチャ変更
   - 予防措置と監視強化
   - ドキュメントとプロセス改善

4. **実装ステップ**:
   - 具体的なAzure CLIコマンドを含む優先順位付きアクションアイテム
   - テストと検証手順
   - 各変更のロールバック計画
   - 問題解決を検証する監視

### ステップ7: ユーザー確認・レポート生成
**アクション**: 発見事項を提示し修復アクションの承認を得る
**プロセス**:
1. **ヘルス評価サマリーの表示**:
   ```
   🏥 Azure リソースヘルス評価
   
   📊 リソース概要:
   • リソース: [名前] ([タイプ])
   • ステータス: [健康/警告/クリティカル]
   • 場所: [リージョン]
   • 最終分析: [タイムスタンプ]
   
   🚨 特定された問題:
   • クリティカル: X個の即座に注意が必要な問題
   • 高: Y個のパフォーマンス/信頼性に影響する問題  
   • 中: Z個の最適化のための問題
   • 低: N個の情報アイテム
   
   🔍 主要問題:
   1. [問題タイプ]: [説明] - 影響: [高/中/低]
   2. [問題タイプ]: [説明] - 影響: [高/中/低]
   3. [問題タイプ]: [説明] - 影響: [高/中/低]
   
   🛠️ 修復計画:
   • 即座のアクション: X項目
   • 短期修正: Y項目  
   • 長期改善: Z項目
   • 推定解決時間: [タイムライン]
   
   ❓ 詳細な修復計画を続行しますか？ (y/n)
   ```

2. **詳細レポートの生成**:
   ```markdown
   # Azureリソースヘルスレポート: [リソース名]
   
   **生成日時**: [タイムスタンプ]  
   **リソース**: [完全リソースID]  
   **全体的ヘルス**: [色インジケーター付きステータス]
   
   ## 🔍 エグゼクティブサマリー
   [ヘルス状態と主要発見事項の簡潔な概要]
   
   ## 📊 ヘルスメトリクス
   - **可用性**: 過去24時間でX%
   - **パフォーマンス**: [平均応答時間/スループット]
   - **エラー率**: 過去24時間でX%
   - **リソース使用率**: [CPU/メモリ/ストレージパーセンテージ]
   
   ## 🚨 特定された問題
   
   ### クリティカル問題
   - **[問題1]**: [説明]
     - **根本原因**: [分析]
     - **影響**: [ビジネス影響]
     - **即座のアクション**: [必要ステップ]
   
   ### 高優先度問題  
   - **[問題2]**: [説明]
     - **根本原因**: [分析]
     - **影響**: [パフォーマンス/信頼性影響]
     - **推奨修正**: [解決ステップ]
   
   ## 🛠️ 修復計画
   
   ### フェーズ1: 即座のアクション（0-2時間）
   ```bash
   # サービスを復旧するクリティカルな修正
   [説明付きAzure CLIコマンド]
   ```
   
   ### フェーズ2: 短期修正（2-24時間）
   ```bash
   # パフォーマンスと信頼性の改善
   [説明付きAzure CLIコマンド]
   ```
   
   ### フェーズ3: 長期改善（1-4週間）
   ```bash
   # アーキテクチャと予防措置
   [Azure CLIコマンドと設定変更]
   ```
   
   ## 📈 監視推奨事項
   - **設定するアラート**: [推奨アラートのリスト]
   - **作成するダッシュボード**: [監視ダッシュボード提案]
   - **定期ヘルスチェック**: [推奨頻度と範囲]
   
   ## ✅ 検証ステップ
   - [ ] ログを通じて問題解決を確認
   - [ ] パフォーマンス改善を確認
   - [ ] アプリケーション機能をテスト
   - [ ] 監視とアラートを更新
   - [ ] 学んだ教訓を文書化
   
   ## 📝 予防措置
   - [類似問題を防ぐための推奨事項]
   - [プロセス改善]
   - [監視強化]
   ```

## エラー処理
- **リソースが見つからない**: リソース名/場所の指定に関するガイダンスを提供
- **認証問題**: Azure認証設定を通してユーザーをガイド
- **不十分な権限**: リソースアクセスに必要なRBACロールをリスト
- **ログが利用不可**: 診断設定を有効にしデータを待つことを提案
- **クエリタイムアウト**: 分析をより小さな時間ウィンドウに分割
- **サービス固有の問題**: 制限事項を記録した一般的なヘルス評価を提供

## 成功基準
- ✅ リソースヘルス状態が正確に評価された
- ✅ すべての重要な問題が特定され分類された
- ✅ 主要問題の根本原因分析が完了した
- ✅ 具体的ステップを含む実行可能な修復計画が提供された
- ✅ 監視と予防推奨事項が含まれた
- ✅ ビジネス影響による問題の明確な優先順位付け
- ✅ 実装ステップが検証とロールバック手順を含む